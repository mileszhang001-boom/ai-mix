# Feature Specification: music-mix Automix

**Feature Branch**: `001-automix`  
**Created**: 2026-02-17  
**Status**: Draft  
**Input**: User description: "实现 Apple Music 的 Automix 体验；提供一个 mp3 文件库，实现不同音乐之间更丝滑的过渡"

## User Scenarios & Testing

### User Story 1 - 扫描音乐库并检测 BPM (Priority: P1)

作为用户，我提供一个包含多首 mp3 文件的文件夹路径，系统能够自动扫描并识别出所有音乐文件的 BPM 值。

**Why this priority**: BPM 是实现节拍对齐的基础数据，没有 BPM 就无法实现 Automix。这是所有后续功能的前提。

**Independent Test**: 可以通过 CLI 指定文件夹，系统输出每首歌曲的 BPM 检测结果，可人工验证准确性。

**Acceptance Scenarios**:

1. **Given** 文件夹中有 5 首 mp3 文件，**When** 运行 BPM 检测，**Then** 系统输出每首歌曲的 BPM 值
2. **Given** 文件夹中包含非 mp3 文件，**When** 运行 BPM 检测，**Then** 系统跳过非 mp3 文件，只处理 mp3
3. **Given** 文件夹为空，**When** 运行 BPM 检测，**Then** 系统返回空结果并提示

---

### User Story 2 - 节拍对齐的自动混音 (Priority: P1)

作为用户，我选择两首歌曲进行混音，系统能够自动分析它们的节拍，并在最佳时机进行过渡，输出一个混合后的音频文件。

**Why this priority**: 这是 Automix 的核心能力——让两首歌曲在节拍上对齐，实现丝滑的听觉体验，接近 Apple Music 的体验。

**Independent Test**: 可以播放混合后的音频，人工判断过渡是否自然顺畅，是否在节拍点上。

**Acceptance Scenarios**:

1. **Given** 两首 BPM 相同的歌曲，**When** 执行混音，**Then** 系统在歌曲 A 结尾自然过渡到歌曲 B，过渡时间 5-10 秒
2. **Given** 两首 BPM 不同的歌曲，**When** 执行混音，**Then** 系统进行 tempo 调整使两首歌曲 BPM 一致后再过渡
3. **Given** 歌曲 A 结尾和歌曲 B 开头有明显的静音段，**When** 执行混音，**Then** 系统自动跳过静音段，在有内容的位置开始过渡

---

### User Story 3 - 多种过渡策略可对比 (Priority: P1)

作为用户，我可以同时生成多种过渡策略的混音结果，并在前端 Demo 中自由切换对比播放，以便找出最适合当前两首歌曲的过渡方式。

**Why this priority**: 不同类型的音乐适合不同的过渡方式；通过 A/B 对比让音频专家和用户能主观选择最佳方案，这是迭代优化算法的关键。

**Independent Test**: 在 Demo 中选择两首歌曲，点击"生成混音"，然后切换不同的过渡策略选项卡，对比播放效果。

**Acceptance Scenarios**:

1. **Given** 两首歌曲已选择，**When** 点击生成混音，**Then** 系统同时生成所有过渡策略的结果
2. **Given** 多种过渡策略已生成，**When** 用户切换策略选项卡，**Then** 播放器立即切换到对应的混音结果，无需重新计算
3. **Given** 某种过渡策略生成失败，**Then** 该策略选项卡显示"生成失败"提示，不影响其他策略
4. **Given** 用户正在播放某策略的混音结果，**When** 切换到另一策略，**Then** 播放自动从头开始新策略的混音
5. **Given** 策略选项卡展示，**When** 用户将鼠标悬停在策略名称上，**Then** 显示该策略的中文说明（原理、适用场景、优劣势）

---

### User Story 4 - 播放列表自动混音 (Priority: P2)

作为用户，我提供一个播放列表（多首歌曲），系统能够自动生成一个完整的混音音频流，实现从头到尾的丝滑播放。

**Why this priority**: 用户期望的是连续的播放体验，而不是手动一首首混音。

**Independent Test**: 提供 5 首歌曲的播放列表，系统输出一个完整的混音音频，可以连续播放无感切换。

**Acceptance Scenarios**:

1. **Given** 播放列表有 3 首歌曲，**When** 执行自动混音，**Then** 系统依次混音生成连续音频
2. **Given** 播放列表中相邻两首歌曲无法进行节拍对齐，**When** 执行自动混音，**Then** 系统使用默认 Crossfade 过渡并记录警告
3. **Given** 播放列表只有 1 首歌曲，**When** 执行自动混音，**Then** 系统输出原歌曲不变

---

### User Story 5 - 前端 Demo 播放器 (Priority: P3)

作为一个测试用户，我可以通过浏览器打开一个 Demo 页面，上传/选择本地 mp3 文件，实时预览混音效果。

**Why this priority**: 便于直观验证算法效果，无需通过命令行操作。

**Independent Test**: 在浏览器中打开 Demo，选择歌曲，点击混音按钮，播放混合后的音频。

**Acceptance Scenarios**:

1. **Given** Demo 页面打开，**When** 用户选择两首 mp3 文件，**Then** 页面显示两首歌曲信息（名称、时长、BPM）
2. **Given** 用户点击"生成混音"按钮，**When** 混音完成，**Then** 页面显示播放控件，可以播放混音结果
3. **Given** 混音过程中发生错误，**Then** 页面显示错误信息，不崩溃

---

### Edge Cases

- 两首歌曲 BPM 差异过大（> 30%）时的处理策略
- 歌曲时长过短（< 30秒）时的混音处理
- 歌曲格式损坏或无法读取时的容错处理
- 多首歌曲连续混音时的性能问题
- 内存占用过大时的处理
- 某些过渡策略不适用于特定音乐类型时的处理（如 Harmonic mix 对和声分析失败时）
- 多个过渡策略同时生成时的资源占用控制

## Requirements

### Functional Requirements

- **FR-001**: 系统 MUST 支持扫描指定文件夹，递归查找所有 mp3 文件
- **FR-002**: 系统 MUST 实现 BPM 检测算法，检测准确率目标 > 90%
- **FR-003**: 系统 MUST 实现节拍对齐算法，使两首歌曲在过渡时 BPM 一致
- **FR-004**: 系统 MUST 支持以下过渡策略，每种策略需附带中文说明：

  | 策略名称 | 原理 | 适用场景 | 优势 | 劣势 |
  |----------|------|----------|------|------|
  | **Crossfade** | 音量淡入淡出 | 任意风格 | 简单稳定，100% 可靠 | 缺乏创意，较平淡 |
  | **Beat-sync** | 节奏同步：通过时间拉伸（±15%）让两首歌 BPM 一致，超出限制则 fallback 到 Crossfade | 节奏相近的电子/舞曲 | 节奏连贯，混音感强 | 对 BPM 准确度要求高 |
  | **Harmonic Mix** | 调性匹配：利用五度圈理论，和谐调性深度重叠 | 调性明确的流行/摇滚 | 听感和谐 | 对电子音乐效果差，计算复杂 |

  > **实现说明**：
  > - Beat-sync：限制 ±15% 拉伸，超出自动 fallback 到 Crossfade
  > - 不实现 Phase Align：librosa 难以准确识别小节边界，收益不明显
  > - 不实现 Segment Match：需要预训练模型，Demo 阶段过于复杂
  > - Echo fade、Filter sweep：作为后续迭代选项
- **FR-005**: 系统 MUST 支持播放列表混音，生成连续的混音音频流
- **FR-006**: 系统 MUST 通过 CLI 暴露核心功能，支持参数：`--input`, `--output`, `--strategy`, `--format json`
- **FR-007**: 系统 MUST 输出结构化日志，记录 BPM 检测结果、过渡类型、混音耗时等信息
- **FR-008**: 系统 MUST 实现前端 Demo 播放器，支持上传 mp3、预览混音结果
- **FR-009**: 系统 MUST 实现模块化设计，核心算法库（mixer_core）可独立导入使用
- **FR-010**: 系统 MUST 实现混音兼容性评估，对两首歌曲进行打分（0-100分）
- **FR-011**: 系统 MUST 基于兼容性评分推荐最佳混音策略，并提供一句话原因说明
- **FR-012**: 系统 MUST 支持以下评估维度：BPM差异、调性匹配度、节拍稳定性

### 兼容性评估规则

| 评分区间 | 级别 | 推荐策略 | 说明 |
|----------|------|----------|------|
| 80-100 | 极佳 | Beat-sync | BPM接近，节拍清晰 |
| 70-80 | 优秀 | Beat-sync/Harmonic | 节奏或调性和谐 |
| 50-70 | 一般 | Crossfade | 稳定可靠 |
| 30-50 | 较差 | Echo-fade | 用效果掩盖不协调 |
| <30 | 极差 | 警告 | 建议更换歌曲 |

### 评分权重

- BPM兼容性: 40%
- 调性匹配度: 30%  
- 节拍稳定性: 30%

### Key Entities

- **Track**: 代表一首音乐曲目，包含文件路径、文件名、时长、BPM、节拍位置数组
- **Transition**: 代表两次歌曲之间的过渡，包含过渡类型、开始时间、结束时间、混合参数
- **MixResult**: 代表混音结果，包含输入曲目列表、过渡信息、输出文件路径

## Success Criteria

### Measurable Outcomes

- **SC-001**: BPM 检测准确率 > 90%（以人工标注为基准）
- **SC-002**: 节拍对齐后的过渡自然度评分 > 4/5（主观评测）
- **SC-003**: 混音处理速度 < 歌曲时长的 20%（例如 3 分钟歌曲混音 < 36 秒）
- **SC-004**: CLI 工具可在 5 秒内完成启动并响应
- **SC-005**: 前端 Demo 页面加载时间 < 3 秒
- **SC-006**: 连续播放 10 首歌曲的混音音频，无明显卡顿或音质问题
- **SC-007**: 前端 Demo 支持 5+ 种过渡策略的实时切换，切换延迟 < 500ms
- **SC-008**: 每种过渡策略的混音结果可独立保存和导出
- **SC-009**: 每种过渡策略的说明在 UI 上清晰可读，悬停响应时间 < 200ms
- **SC-010**: Beat-sync 策略时间拉伸幅度限制在 ±15% 以内，超出自动 fallback 到 Crossfade
- **SC-011**: BPM 差异超过 15% 时自动切换到 Crossfade 策略并记录日志
- **SC-012**: 兼容性评估响应时间 < 2秒
- **SC-013**: 兼容性评分显示在前端，一句话推荐原因清晰可读
