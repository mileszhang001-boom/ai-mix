# Implementation Plan: music-mix Automix

**Branch**: `001-automix` | **Date**: 2026-02-17 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-automix/spec.md`

## Summary

å®ç° Apple Music é£æ ¼çš„ Automix è‡ªåŠ¨æ··éŸ³åŠŸèƒ½ã€‚é€šè¿‡åˆ†ææœ¬åœ° mp3 éŸ³ä¹åº“çš„ BPM å’ŒèŠ‚æ‹ï¼Œå®ç°å¤šç­–ç•¥çš„ä¸æ»‘è¿‡æ¸¡ã€‚æ ¸å¿ƒæ¨¡å—ï¼ˆmixer_coreï¼‰ä¸å‰ç«¯ Demo åˆ†ç¦»ï¼Œä¾¿äºåç»­é›†æˆåˆ°ä¸»æ’­æ”¾å™¨ã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
1. ä½¿ç”¨ librosa è¿›è¡ŒéŸ³é¢‘åˆ†æï¼ˆBPM æ£€æµ‹ã€èŠ‚æ‹è¿½è¸ªã€å’Œå£°åˆ†æï¼‰
2. ä½¿ç”¨ pydub è¿›è¡ŒéŸ³é¢‘å¤„ç†å’Œæ··éŸ³
3. å‰ç«¯ Demo ä½¿ç”¨åŸç”Ÿ HTML + JavaScriptï¼Œå¿«é€Ÿå¯åŠ¨ä¾¿äºæµ‹è¯•

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**: 
- `librosa` (éŸ³é¢‘åˆ†æï¼šBPM æ£€æµ‹ã€èŠ‚æ‹è¿½è¸ª)
- `pydub` (éŸ³é¢‘å¤„ç†ï¼šæ··éŸ³ã€æ·¡å…¥æ·¡å‡º)
- `click` / `typer` (CLI æ¡†æ¶)
- `numpy`, `scipy` (ä¿¡å·å¤„ç†åº•å±‚)

**Storage**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆmp3 æ–‡ä»¶åº“ï¼‰  
**Testing**: pytest + pytest-cov  
**Target Platform**: æœ¬åœ°è¿è¡Œï¼ˆCLI + æµè§ˆå™¨ Demoï¼‰  
**Project Type**: åº“ + CLI å·¥å…· + Web å‰ç«¯ Demo  
**Performance Goals**: æ··éŸ³å¤„ç†é€Ÿåº¦ < æ­Œæ›²æ—¶é•¿ 20%  
**Constraints**: ç¦»çº¿è¿è¡Œï¼Œä¸ä¾èµ–åœ¨çº¿æœåŠ¡  
**Scale/Scope**: å•ä¸€ç”¨æˆ·æœ¬åœ°ä½¿ç”¨ï¼Œæ”¯æŒ ~1000 é¦–æ­Œæ›²çš„éŸ³ä¹åº“

## Constitution Check

| æ¡æ¬¾ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| I. æ¨¡å—åŒ–æ¶æ„ | âœ… PASS | mixer_core ç‹¬ç«‹æˆåº“ï¼Œå¯å¯¼å…¥ä½¿ç”¨ |
| II. CLI æ¥å£ | âœ… PASS | ä½¿ç”¨ Click/Typer å®ç° CLI |
| III. æµ‹è¯•é©±åŠ¨ | âœ… PASS | éµå¾ª TDD æµç¨‹ |
| IV. æ–‡ä»¶é©±åŠ¨ | âœ… PASS | æ‰«ææœ¬åœ° mp3 æ–‡ä»¶åº“ |
| V. BPM æ£€æµ‹ä¸èŠ‚æ‹å¯¹é½ | âœ… PASS | ä½¿ç”¨ librosa å®ç° |
| VI. å¯è§‚æµ‹æ€§ | âœ… PASS | ç»“æ„åŒ–æ—¥å¿—è¾“å‡º |
| VII. ç‰ˆæœ¬ç®¡ç† | âœ… PASS | é‡‡ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ |
| VIII. æµ‹è¯•é—­ç¯ | âœ… PASS | æ¯ä¸ªæ¨¡å—å®ŒæˆåéªŒè¯ |

## Project Structure

### Documentation (this feature)

```
specs/001-automix/
â”œâ”€â”€ plan.md              # æœ¬æ–‡ä»¶
â”œâ”€â”€ spec.md              # éœ€æ±‚è§„æ ¼
â”œâ”€â”€ research.md          # æŠ€æœ¯è°ƒç ”ï¼ˆPhase 0ï¼‰
â”œâ”€â”€ data-model.md        # æ•°æ®æ¨¡å‹ï¼ˆPhase 1ï¼‰
â”œâ”€â”€ quickstart.md        # å¿«é€Ÿå…¥é—¨ï¼ˆPhase 1ï¼‰
â”œâ”€â”€ contracts/           # æ¥å£å®šä¹‰ï¼ˆPhase 1ï¼‰
â””â”€â”€ tasks.md             # ä»»åŠ¡æ¸…å•ï¼ˆPhase 2ï¼‰
```

### Source Code

```
music_mix/
â”œâ”€â”€ mixer_core/                    # æ ¸å¿ƒç®—æ³•åº“ï¼ˆç‹¬ç«‹å¯å¯¼å…¥ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ bpm_detector.py           # BPM æ£€æµ‹
â”‚   â”œâ”€â”€ beat_tracker.py           # èŠ‚æ‹è¿½è¸ª
â”‚   â”œâ”€â”€ transition/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py               # è¿‡æ¸¡ç­–ç•¥åŸºç±»
â”‚   â”‚   â”œâ”€â”€ crossfade.py          # Crossfade ç­–ç•¥
â”‚   â”‚   â””â”€â”€ beat_sync.py          # Beat-sync ç­–ç•¥
â”‚   â”œâ”€â”€ mixer.py                  # æ··éŸ³å¼•æ“
â”‚   â”œâ”€â”€ playlist.py               # æ’­æ”¾åˆ—è¡¨å¤„ç†
â”‚   â””â”€â”€ cli.py                    # CLI å…¥å£
â”œâ”€â”€ demo/                         # å‰ç«¯ Demo
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ styles.css
â”‚   â”œâ”€â”€ app.js                   # ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ player.js                 # éŸ³é¢‘æ’­æ”¾å™¨
â”‚   â””â”€â”€ strategy-descriptions.js # ç­–ç•¥è¯´æ˜ï¼ˆä¸­è‹±æ–‡ï¼‰
â”œâ”€â”€ tests/                        # æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ test_bpm_detector.py
â”‚   â”‚   â””â”€â”€ test_transitions/
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â””â”€â”€ test_mixer.py
â”‚   â””â”€â”€ fixtures/                 # æµ‹è¯•éŸ³é¢‘æ–‡ä»¶
â”œâ”€â”€ data/                         # ç¤ºä¾‹éŸ³ä¹åº“ï¼ˆç”¨æˆ·æä¾›çš„ mp3ï¼‰
â”œâ”€â”€ specs/                        # éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ pyproject.toml                # Python é¡¹ç›®é…ç½®
â””â”€â”€ README.md
```

**Structure Decision**: 
- `mixer_core` ä½œä¸ºç‹¬ç«‹ Python åŒ…ï¼Œé€šè¿‡ `pyproject.toml` é…ç½®
- å‰ç«¯ Demo æ”¾åœ¨ `demo/` ç›®å½•ï¼Œå•é¡µé¢åº”ç”¨å¯ç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€
- æµ‹è¯•æ–‡ä»¶æ”¾åœ¨ `tests/` ç›®å½•

## Phase Plan

### Phase 1: åŸºç¡€è®¾æ–½ä¸æ ¸å¿ƒç®—æ³•

**ç›®æ ‡**: å®Œæˆ BPM æ£€æµ‹ã€èŠ‚æ‹è¿½è¸ªåŸºç¡€èƒ½åŠ›ï¼ŒCLI å¯ç”¨

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P1.1 | é¡¹ç›®åˆå§‹åŒ–ï¼špyproject.tomlã€ç›®å½•ç»“æ„ | - |
| P1.2 | å®ç° BPM æ£€æµ‹ç®—æ³•ï¼ˆlibrosaï¼‰ | - |
| P1.3 | å®ç°èŠ‚æ‹è¿½è¸ªï¼ˆbeat trackingï¼‰ | P1.2 |
| P1.4 | CLI åŸºç¡€åŠŸèƒ½ï¼šscanã€analyze å‘½ä»¤ | P1.3 |
| P1.5 | å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆBPM æ£€æµ‹å‡†ç¡®ç‡ > 90%ï¼‰ | P1.3 |

**äº¤ä»˜ç‰©**: å¯é€šè¿‡ CLI æ‰«ææ–‡ä»¶å¤¹å¹¶è·å–æ¯é¦–æ­Œçš„ BPM

### Phase 2: æ··éŸ³å¼•æ“ä¸åŸºç¡€è¿‡æ¸¡ç­–ç•¥

**ç›®æ ‡**: å®ç°æ··éŸ³æ ¸å¿ƒé€»è¾‘ï¼Œæ”¯æŒåŸºç¡€è¿‡æ¸¡ç­–ç•¥

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P2.1 | å®ç°æ··éŸ³å¼•æ“ï¼ˆä¸¤é¦–æ­Œæ›²æ··åˆï¼‰ | P1.4 |
| P2.2 | å®ç° Crossfade è¿‡æ¸¡ç­–ç•¥ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰ | P2.1 |
| P2.3 | å®ç° Beat-sync è¿‡æ¸¡ç­–ç•¥ï¼ˆé™åˆ¶ Â±15% æ‹‰ä¼¸ï¼Œè¶…å‡º fallbackï¼‰ | P2.1 |
| P2.4 | é›†æˆæµ‹è¯•ï¼šæ··éŸ³è¾“å‡ºéªŒè¯ | P2.2-3 |

**äº¤ä»˜ç‰©**: CLI å¯æ‰§è¡Œ `mix track_a.mp3 track_b.mp3 --strategy beat_sync`

### Phase 3: å‰ç«¯ Demo

**ç›®æ ‡**: Web ç•Œé¢ç”¨äºæµ‹è¯•å’Œå¯¹æ¯”

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P3.1 | Demo é¡µé¢åŸºç¡€å¸ƒå±€ | - |
| P3.2 | æ­Œæ›²é€‰æ‹©ä¸ä¸Šä¼ åŠŸèƒ½ | - |
| P3.3 | è°ƒç”¨åç«¯æ··éŸ³ API | P2.4 |
| P3.4 | ç­–ç•¥åˆ‡æ¢å¯¹æ¯”åŠŸèƒ½ | P3.3 |
| P3.5 | ç­–ç•¥è¯´æ˜æ‚¬åœæ˜¾ç¤º | P3.4 |

**äº¤ä»˜ç‰©**: å¯åœ¨æµè§ˆå™¨æ‰“å¼€çš„ Demo é¡µé¢

### Phase 3.5: å…¼å®¹æ€§è¯„ä¼°

**ç›®æ ‡**: å®ç°æ··éŸ³å…¼å®¹æ€§è¯„ä¼°ä¸ç­–ç•¥æ¨è

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P3.5.1 | å®ç°å…¼å®¹æ€§è¯„ä¼°æ¨¡å— (mixer_core/compatibility.py) | P2.1 |
| P3.5.2 | å®ç°è°ƒæ€§æ£€æµ‹ä¸äº”åº¦åœˆåŒ¹é… | P3.5.1 |
| P3.5.3 | å®ç°ç»¼åˆè¯„åˆ†ç®—æ³• | P3.5.2 |
| P3.5.4 | ç­–ç•¥æ¨èä¸ä¸€å¥è¯åŸå› ç”Ÿæˆ | P3.5.3 |
| P3.5.5 | å‰ç«¯æ˜¾ç¤ºå…¼å®¹æ€§è¯„åˆ†ä¸æ¨è | P3.5.4 |

**äº¤ä»˜ç‰©**: é€‰æ‹©æ­Œæ›²åæ˜¾ç¤ºå…¼å®¹æ€§è¯„åˆ†ä¸æ¨èç­–ç•¥

### Phase 4: æ’­æ”¾åˆ—è¡¨ä¸é›†æˆ

**ç›®æ ‡**: æ”¯æŒå¤šæ­Œæ›²è¿ç»­æ··éŸ³

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P4.1 | æ’­æ”¾åˆ—è¡¨å¤„ç† | P3.5 |
| P4.2 | è¿ç»­æ··éŸ³æµç”Ÿæˆ | P4.1 |
| P4.3 | Demo æ’­æ”¾åˆ—è¡¨åŠŸèƒ½ | P4.1 |
| P4.4 | æ€§èƒ½ä¼˜åŒ–ä¸æµ‹è¯•é—­ç¯ | P4.3 |

**äº¤ä»˜ç‰©**: å®Œæ•´çš„ Automix åŠŸèƒ½

### Phase 5: é«˜çº§ç­–ç•¥ï¼ˆå¯é€‰è¿­ä»£ï¼‰

**ç›®æ ‡**: å®ç° Harmonic Mixï¼ˆåç»­è¿­ä»£ï¼‰

| ä»»åŠ¡ | æè¿° | ä¾èµ– |
|------|------|------|
| P5.1 | å®ç° Harmonic Mixï¼ˆäº”åº¦åœˆè°ƒæ€§åŒ¹é…ï¼‰ | P2.1 |
| P5.2 | è°ƒæ€§æ£€æµ‹å‡†ç¡®ç‡ä¼˜åŒ– | P5.1 |
| P5.3 | ç­–ç•¥å¯¹æ¯”æµ‹è¯•ä¸è°ƒä¼˜ | P5.2 |

**äº¤ä»˜ç‰©**: Harmonic Mix è¿‡æ¸¡ç­–ç•¥å¯ç”¨

## API Design

### CLI æ¥å£

```bash
# æ‰«æéŸ³ä¹åº“
music-mix scan <folder_path> [--format json]

# åˆ†æå•é¦–æ­Œæ›²
music-mix analyze <file.mp3> [--format json]

# æ··éŸ³ä¸¤é¦–æ­Œæ›²
music-mix mix <track_a.mp3> <track_b.mp3> --strategy <strategy> [--output <output.mp3>]

# æ’­æ”¾åˆ—è¡¨æ··éŸ³
music-mix playlist <folder> --output <output.mp3> [--strategy <strategy>]
```

### Python åº“æ¥å£

```python
from mixer_core import BPMDetector, Mixer, TransitionFactory

# BPM æ£€æµ‹
detector = BPMDetector()
bpm = detector.detect("track.mp3")

# æ··éŸ³
mixer = Mixer()
result = mixer.mix(track_a, track_b, strategy="beat_sync")
result.save("output.mp3")

# å·¥å‚åˆ›å»ºè¿‡æ¸¡ç­–ç•¥
strategy = TransitionFactory.create("crossfade")
```

### ç­–ç•¥è¯´æ˜æ•°æ®ç»“æ„

```python
STRATEGY_DESCRIPTIONS = {
    "crossfade": {
        "name": "Crossfade",
        "name_cn": "æ·¡å…¥æ·¡å‡º",
        "åŸç†": "é€šè¿‡éŸ³é‡æ·¡å…¥æ·¡å‡ºå®ç°ä¸¤é¦–æ­Œæ›²çš„å¹³æ»‘è¿‡æ¸¡",
        "é€‚ç”¨åœºæ™¯": "é£æ ¼å·®å¼‚è¾ƒå¤§çš„æ­Œæ›²ï¼ŒèŠ‚å¥ä¸æ˜æ˜¾åŒ¹é…æ—¶",
        "ä¼˜åŠ¿": "ç®€å•ç¨³å®šï¼Œå…¼å®¹æ€§å¥½ï¼Œé€‚ç”¨äºä»»ä½•æ­Œæ›²",
        "åŠ£åŠ¿": "ç¼ºä¹åˆ›æ„ï¼Œè¿‡æ¸¡è¾ƒä¸ºå¹³æ·¡"
    },
    # ... å…¶ä»–ç­–ç•¥
}
```

## Data Model

### Track

```python
class Track:
    path: str              # æ–‡ä»¶è·¯å¾„
    filename: str          # æ–‡ä»¶å
    duration: float        # æ—¶é•¿ï¼ˆç§’ï¼‰
    bpm: float             # BPM å€¼
    beats: list[int]       # èŠ‚æ‹ä½ç½®æ•°ç»„ï¼ˆå¸§æ•°ï¼‰
    key: str               # è°ƒæ€§ï¼ˆå¦‚ "C minor"ï¼‰
    energy: float          # èƒ½é‡å€¼ (0-1)
    has_vocal: bool        # æ˜¯å¦æœ‰äººå£°
```

### Transition

```python
class Transition:
    strategy: str          # ç­–ç•¥åç§°
    track_a: Track          # æºæ›²ç›®
    track_b: Track          # ç›®æ ‡æ›²ç›®
    start_time: float       # è¿‡æ¸¡å¼€å§‹æ—¶é—´ï¼ˆç§’ï¼‰
    end_time: float         # è¿‡æ¸¡ç»“æŸæ—¶é—´ï¼ˆç§’ï¼‰
    params: dict            # ç­–ç•¥å‚æ•°
```

### MixResult

```python
class MixResult:
    tracks: list[Track]     # å‚ä¸æ··éŸ³çš„æ›²ç›®
    transitions: list[Transition]  # è¿‡æ¸¡ä¿¡æ¯
    output_path: str        # è¾“å‡ºæ–‡ä»¶è·¯å¾„
    duration: float         # æ€»æ—¶é•¿
    strategy: str          # ä½¿ç”¨çš„ç­–ç•¥
```

## Risk Assessment

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| BPM æ£€æµ‹å‡†ç¡®ç‡ä¸è¶³ 90% | ğŸ”´ é«˜ | é›†æˆ librosa + madmomï¼›æä¾›äººå·¥ä¿®æ­£æ¥å£ |
| BPM å·®å¼‚å¤§å¯¼è‡´éŸ³è´¨ä¸‹é™ | ğŸ”´ é«˜ | é™åˆ¶æ‹‰ä¼¸å¹…åº¦ < 15%ï¼›è¶…å‡ºåˆ™ä½¿ç”¨ Crossfade |
| è¿‡æ¸¡ä¸è‡ªç„¶ | ğŸŸ¡ ä¸­ | åœ¨æ£€æµ‹èŠ‚æ‹ç‚¹é™„è¿‘å¾®è°ƒï¼›å¤šç­–ç•¥å¯¹æ¯”é€‰æ‹© |
| é«˜çº§ç­–ç•¥ï¼ˆHarmonic/Vocalï¼‰å‡†ç¡®ç‡æœ‰é™ | ğŸŸ¡ ä¸­ | å¤±è´¥æ—¶è‡ªåŠ¨ fallback åˆ° Crossfade |
| 7 ç§ç­–ç•¥å¼€å‘é‡è¿‡å¤§ | ğŸŸ¡ ä¸­ | ä¼˜å…ˆå®ç° 3 ç§åŸºç¡€ç­–ç•¥ï¼Œå…¶ä»–é€æ­¥è¿­ä»£ |
| æµè§ˆå™¨éŸ³é¢‘å¤„ç†æ€§èƒ½ | ğŸŸ¢ ä½ | æ··éŸ³åœ¨åç«¯å®Œæˆï¼Œå‰ç«¯ä»…æ’­æ”¾ç»“æœ |
| å†…å­˜å ç”¨è¿‡å¤§ | ğŸŸ¢ ä½ | æµå¼å¤„ç†å¤§æ–‡ä»¶ï¼Œé™åˆ¶å¹¶å‘æ•° |

### å·²çŸ¥ä½“éªŒé—®é¢˜

1. **BPM æ£€æµ‹å¯¹ç‰¹å®šé£æ ¼æ•ˆæœå·®**ï¼šå¤å…¸ã€çˆµå£«ã€èŠ‚å¥è‡ªç”±çš„éŸ³ä¹ BPM æ£€æµ‹å¯èƒ½ä¸å‡†ç¡®
2. **æ—¶é—´æ‹‰ä¼¸å¤±çœŸ**ï¼šBPM å·®å¼‚ > 15% æ—¶ä¼šå‡ºç°"æœºå™¨äººå£°"ä¼ªå½±
3. **èŠ‚æ‹ç‚¹åå·®**ï¼šæ£€æµ‹åˆ°çš„èŠ‚æ‹ç‚¹å¯èƒ½æœ‰å°å¹…åå·®ï¼Œå¯¼è‡´è¿‡æ¸¡ä¸å¤Ÿç²¾å‡†
4. **ç­–ç•¥ä¸é€‚ç”¨**ï¼šæŸäº›ç­–ç•¥å¯¹ç‰¹å®šéŸ³ä¹ç±»å‹æ•ˆæœå·®ï¼Œéœ€è¦ fallback æœºåˆ¶

## Complexity Tracking

æœ¬é¡¹ç›®æ— éœ€å®ªæ³•è¿è§„é¡¹ã€‚

## Next Steps

1. æ‰§è¡Œ Phase 1ï¼šé¡¹ç›®åˆå§‹åŒ–ä¸ BPM æ£€æµ‹
2. åˆ›å»º `research.md` è®°å½•æŠ€æœ¯é€‰å‹ç»†èŠ‚
3. åˆ›å»º `data-model.md` å®Œå–„æ•°æ®ç»“æ„å®šä¹‰
