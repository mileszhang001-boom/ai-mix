<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹mixæ•ˆæœå®éªŒ ğŸ”§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1a;
            color: #fff;
            padding: 24px;
        }

        .container { max-width: 520px; margin: 0 auto; }

        h1 {
            text-align: center;
            margin-bottom: 28px;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .step {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .step-title {
            font-size: 0.7rem;
            color: #555;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ä¸Šä¼  */
        .upload-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .upload-btn {
            border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-btn:hover { border-color: #00d4ff; background: rgba(0,212,255,0.05); }
        .upload-btn input { display: none; }
        .upload-btn .icon { font-size: 2rem; margin-bottom: 8px; }
        .upload-btn .name { font-size: 0.75rem; color: #777; }

        /* ç¡®è®¤æŒ‰é’® */
        .confirm-btn {
            width: 100%;
            padding: 14px;
            background: #00d4ff;
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }
        .confirm-btn:hover:not(:disabled) { background: #33ddff; }
        .confirm-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* æ³¢å½¢é¢„è§ˆ */
        .wave-preview {
            margin-top: 16px;
            display: none;
        }
        
        .wave-track { margin-bottom: 10px; }

        .wave-track .track-name {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .wave-track .dot { width: 6px; height: 6px; border-radius: 50%; }
        
        .wave-canvas {
            background: #080810;
            border-radius: 8px;
            width: 100%;
            height: 48px;
        }
        
        .wave-canvas canvas {
            width: 100%;
            height: 48px;
            display: block;
        }

        /* å…¼å®¹æ€§è¯„ä¼° */
        .compat-result {
            margin: 16px 0;
            padding: 14px;
            background: rgba(0,212,255,0.06);
            border: 1px solid rgba(0,212,255,0.15);
            border-radius: 10px;
            display: none;
        }
        
        .compat-result.show { display: block; }
        
        .compat-score {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00d4ff;
            margin-bottom: 4px;
        }
        
        .compat-recommend {
            font-size: 0.75rem;
            color: #888;
        }
        
        .compat-recommend span { color: #00d4ff; font-weight: 500; }

        /* ç­–ç•¥ */
        .strategy-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .strategy-btn {
            padding: 12px 6px;
            background: rgba(0,0,0,0.3);
            border: 1px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.65rem;
            text-align: center;
            transition: all 0.2s;
        }
        
        .strategy-btn:hover { background: rgba(0,212,255,0.1); }
        
        .strategy-btn.active {
            border-color: #00d4ff;
            background: rgba(0,212,255,0.12);
            color: #00d4ff;
        }
        
        .strategy-btn .name { font-weight: 600; margin-bottom: 2px; }

        /* ç”ŸæˆæŒ‰é’® */
        .gen-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00d4ff, #6366f1);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gen-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,212,255,0.3); }
        .gen-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading { text-align: center; padding: 20px; color: #00d4ff; }
        .error { text-align: center; padding: 12px; background: rgba(255,0,0,0.1); border-radius: 8px; color: #ff6666; margin-top: 12px; }

        /* ç¡®è®¤æ­¥éª¤ */
        .eval-result {
            margin: 16px 0;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            display: none;
        }
        .eval-result.show { display: block; }

        .eval-score {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }
        .eval-score.high { color: #4ade80; }
        .eval-score.medium { color: #fbbf24; }
        .eval-score.low { color: #f87171; }

        .eval-details {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-bottom: 12px;
        }

        .eval-details span { color: #aaa; }

        .eval-recommend {
            font-size: 0.75rem;
            color: #888;
            text-align: center;
            margin-bottom: 16px;
        }
        .eval-recommend span { color: #00d4ff; font-weight: 500; }

        .proceed-btn {
            width: 100%;
            padding: 12px;
            background: #2a2a3a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .proceed-btn:hover { background: #3a3a4a; border-color: #00d4ff; }

        /* ç»“æœ */
        .result { display: none; }
        .result.show { display: block; }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 14px;
            font-size: 0.75rem;
            color: #666;
        }
        
        .result-header .highlight { color: #00d4ff; }

        .result-wave {
            background: #080810;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
        }
        
        .result-wave .label {
            font-size: 0.7rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .result-wave canvas {
            width: 100%;
            height: 56px;
            border-radius: 6px;
        }

        audio { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>éŸ³ä¹mixæ•ˆæœå®éªŒ ğŸ”§</h1>

        <!-- æ­¥éª¤1: ä¸Šä¼ æ­Œæ›² -->
        <div class="step">
            <div class="step-title">1. ä¸Šä¼ æ­Œæ›²</div>
            <div class="upload-row">
                <div class="upload-btn" onclick="document.getElementById('fileA').click()">
                    <input type="file" id="fileA" accept="audio/*">
                    <div class="icon">ğŸµ</div>
                    <div class="name" id="nameA">é€‰æ‹©æ­Œæ›² A</div>
                </div>
                <div class="upload-btn" onclick="document.getElementById('fileB').click()">
                    <input type="file" id="fileB" accept="audio/*">
                    <div class="icon">ğŸµ</div>
                    <div class="name" id="nameB">é€‰æ‹©æ­Œæ›² B</div>
                </div>
            </div>
            
            <!-- æ³¢å½¢é¢„è§ˆ -->
            <div class="wave-preview" id="wavePreview">
                <div class="wave-track">
                    <div class="track-name"><span class="dot" style="background:#ff4d4d;"></span> æ­Œæ›² A</div>
                    <div class="wave-canvas"><canvas id="waveA"></canvas></div>
                </div>
                <div class="wave-track">
                    <div class="track-name"><span class="dot" style="background:#4d79ff;"></span> æ­Œæ›² B</div>
                    <div class="wave-canvas"><canvas id="waveB"></canvas></div>
                </div>
            </div>
            
            <button class="confirm-btn" id="confirmBtn" onclick="confirmSelection()" disabled>ç¡®è®¤é€‰æ‹©</button>
        </div>

        <!-- æ­¥éª¤1.5: å…¼å®¹æ€§è¯„ä¼°ç»“æœ -->
        <div class="step" id="evalStep" style="display:none;">
            <div class="step-title">å…¼å®¹æ€§è¯„ä¼°</div>
            
            <div class="eval-result show" id="evalResult">
                <div class="eval-score" id="evalScore">-</div>
                <div class="eval-details" id="evalDetails">
                    BPM: <span>-</span> | è°ƒæ€§: <span>-</span> | èŠ‚å¥: <span>-</span>
                </div>
                <div class="eval-recommend" id="evalRecommend">
                    æ¨èç­–ç•¥: <span>-</span>
                </div>
                <button class="proceed-btn" onclick="proceedToStrategy()">é€‰æ‹©æ··éŸ³ç­–ç•¥ â†’</button>
            </div>
        </div>

        <!-- æ­¥éª¤2: é€‰æ‹©ç­–ç•¥ -->
        <div class="step" id="strategyStep" style="display:none;">
            <div class="step-title">2. é€‰æ‹©ç­–ç•¥</div>
            
            <!-- å…¼å®¹æ€§è¯„ä¼° -->
            <div class="compat-result" id="compatResult">
                <div class="compat-score" id="compatScore">-</div>
                <div class="compat-recommend" id="compatRecommend">-</div>
            </div>
            
            <div class="strategy-row">
                <div class="strategy-btn" data-strategy="crossfade">
                    <div class="name">Crossfade</div>
                    <div>æ·¡å…¥æ·¡å‡º</div>
                </div>
                <div class="strategy-btn" data-strategy="beat_sync">
                    <div class="name">Beat-sync</div>
                    <div>èŠ‚æ‹å¯¹é½</div>
                </div>
                <div class="strategy-btn" data-strategy="echo_fade">
                    <div class="name">Echo</div>
                    <div>å›å£°æ•ˆæœ</div>
                </div>
                <div class="strategy-btn" data-strategy="harmonic">
                    <div class="name">Harmonic</div>
                    <div>è°ƒæ€§åŒ¹é…</div>
                </div>
            </div>
            
            <button class="gen-btn" id="genBtn" onclick="generateMix()">ç”Ÿæˆæ··éŸ³</button>
        </div>

        <!-- æ­¥éª¤3: ç»“æœ -->
        <div class="step result" id="result">
            <div class="step-title">3. æ··éŸ³ç»“æœ</div>
            <div class="result-header">
                <span>ç­–ç•¥: <span class="highlight" id="resStrategy">-</span></span>
                <span>æ—¶é•¿: <span class="highlight" id="resDuration">-</span></span>
                <span>è¿‡æ¸¡ç‚¹: <span class="highlight" id="resTransition">-</span></span>
            </div>
            <div class="result-wave">
                <div class="label">æ··éŸ³æ³¢å½¢ (çº¢â†’è“ è¡¨ç¤ºè¿‡æ¸¡)</div>
                <canvas id="waveMix"></canvas>
            </div>
            <audio id="player" controls></audio>
        </div>
        
        <div class="loading" id="loading" style="display:none;">å¤„ç†ä¸­...</div>
        <div class="error" id="error" style="display:none;"></div>
    </div>

    <script>
        // API åŸºç¡€ URL - ç”Ÿäº§ç¯å¢ƒå¯é…ç½®
        // æœ¬åœ°å¼€å‘: '' (ç›¸å¯¹è·¯å¾„)
        // ç”Ÿäº§ç¯å¢ƒ: 'https://your-render-app.onrender.com'
        const API_BASE = '';

        let fileA = null, fileB = null;
        let currentStrategy = 'crossfade';
        let audioContext = null;

        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('fileA').addEventListener('change', e => {
            if (e.target.files[0]) {
                fileA = e.target.files[0];
                document.getElementById('nameA').textContent = fileA.name.slice(0, 14);
                checkCanConfirm();
            }
        });
        
        document.getElementById('fileB').addEventListener('change', e => {
            if (e.target.files[0]) {
                fileB = e.target.files[0];
                document.getElementById('nameB').textContent = fileB.name.slice(0, 14);
                checkCanConfirm();
            }
        });

        function checkCanConfirm() {
            // æ£€æŸ¥æ˜¯å¦ä¸Šä¼ äº†åŒä¸€é¦–æ›²å­
            if (fileA && fileB) {
                const nameA = fileA.name.toLowerCase();
                const nameB = fileB.name.toLowerCase();
                const sizeA = fileA.size;
                const sizeB = fileB.size;
                
                // æ¯”è¾ƒæ–‡ä»¶åï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰æˆ–å¤§å°å®Œå…¨ç›¸åŒ
                if ((nameA === nameB && nameA !== 'é€‰æ‹©æ­Œæ›² a' && nameB !== 'é€‰æ‹©æ­Œæ›² b') || 
                    (sizeA === sizeB && sizeA > 0)) {
                    showError('âš ï¸ æ£€æµ‹åˆ°ç›¸åŒçš„æ­Œæ›²ï¼Œè¯·é€‰æ‹©ä¸åŒçš„ä¸¤é¦–æ›²ç›®');
                    document.getElementById('confirmBtn').disabled = true;
                    return;
                }
            }
            
            hideError();
            document.getElementById('confirmBtn').disabled = !(fileA && fileB);
            if (fileA && fileB) loadWaveforms();
        }

        async function loadWaveforms() {
            if (!fileA || !fileB) return;
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            document.getElementById('wavePreview').style.display = 'block';
            await new Promise(r => setTimeout(r, 50));
            
            await drawWave(fileA, 'waveA');
            await drawWave(fileB, 'waveB');
        }

        async function drawWave(file, canvasId) {
            const canvas = document.getElementById(canvasId);
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            const width = rect.width || 400;
            const height = 48;
            
            canvas.width = width * 2;
            canvas.height = height * 2;
            
            const buffer = await file.arrayBuffer();
            const audio = await audioContext.decodeAudioData(buffer);
            const data = audio.getChannelData(0);
            
            const step = Math.ceil(data.length / canvas.width);
            const amp = canvas.height / 2;
            const color = canvasId === 'waveA' ? '#ff4d4d' : '#4d79ff';
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            
            for (let i = 0; i < canvas.width; i++) {
                let min = 1, max = -1;
                for (let j = 0; j < step; j++) {
                    const idx = i * step + j;
                    if (idx >= data.length) break;
                    const d = data[idx];
                    if (d < min) min = d;
                    if (d > max) max = d;
                }
                ctx.fillRect(i, (1 + min) * amp, 1, Math.max(1, (max - min) * amp));
            }
        }

        // ç¡®è®¤é€‰æ‹©åè¯„ä¼°å…¼å®¹æ€§
        async function confirmSelection() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('confirmBtn').disabled = true;
            hideError();
            
            try {
                const form = new FormData();
                form.append('track_a', fileA);
                form.append('track_b', fileB);
                
                const res = await fetch(API_BASE + '/api/evaluate', { method: 'POST', body: form });
                const data = await res.json();
                
                if (data.success) {
                    // æ˜¾ç¤ºè¯„ä¼°ç»“æœæ­¥éª¤
                    document.getElementById('evalStep').style.display = 'block';
                    document.getElementById('evalStep').scrollIntoView({ behavior: 'smooth' });
                    
                    // æ›´æ–°è¯„ä¼°æ˜¾ç¤º
                    const score = data.score;
                    const scoreEl = document.getElementById('evalScore');
                    scoreEl.textContent = score + 'åˆ†';
                    scoreEl.className = 'eval-score ' + (score >= 70 ? 'high' : score >= 50 ? 'medium' : 'low');
                    
                    document.getElementById('evalDetails').innerHTML = 
                        'BPM: <span>' + (data.bpm_score || '-') + '</span> | ' +
                        'è°ƒæ€§: <span>' + (data.key_score || '-') + '</span> | ' +
                        'èŠ‚å¥: <span>' + (data.beat_score || '-') + '</span>';
                    
                    document.getElementById('evalRecommend').innerHTML = 
                        'æ¨èç­–ç•¥: <span>' + (data.recommendation_name || data.recommendation) + '</span> - ' + data.reason;
                    
                    // ä¿å­˜æ¨èç­–ç•¥
                    window.recommendedStrategy = data.recommendation;
                    
                    // éšè—ç­–ç•¥é€‰æ‹©æ­¥éª¤ï¼ˆç­‰å¾…ç”¨æˆ·ç¡®è®¤åæ˜¾ç¤ºï¼‰
                    document.getElementById('strategyStep').style.display = 'none';
                    document.getElementById('compatResult').classList.remove('show');
                }
            } catch (err) {
                document.getElementById('error').textContent = err.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('confirmBtn').disabled = false;
            }
        }

        // ç”¨æˆ·ç¡®è®¤åè¿›å…¥ç­–ç•¥é€‰æ‹©
        function proceedToStrategy() {
            document.getElementById('strategyStep').style.display = 'block';
            document.getElementById('strategyStep').scrollIntoView({ behavior: 'smooth' });
            
            // é«˜äº®æ¨èç­–ç•¥
            const recStrategy = window.recommendedStrategy || 'crossfade';
            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.strategy === recStrategy) {
                    btn.classList.add('active');
                    currentStrategy = recStrategy;
                }
            });
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('error').style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // ç­–ç•¥é€‰æ‹©
        document.querySelectorAll('.strategy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.strategy-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentStrategy = btn.dataset.strategy;
            });
        });

        // ç”Ÿæˆæ··éŸ³
        async function generateMix() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('genBtn').disabled = true;

            try {
                const form = new FormData();
                form.append('track_a', fileA);
                form.append('track_b', fileB);
                form.append('strategy', currentStrategy);

                const res = await fetch(API_BASE + '/api/mix', { method: 'POST', body: form });
                const data = await res.json();

                if (!data.success) throw new Error(data.error || 'æ··éŸ³å¤±è´¥');

                const names = { crossfade: 'Crossfade', beat_sync: 'Beat-sync', echo_fade: 'Echo', harmonic: 'Harmonic' };
                document.getElementById('resStrategy').textContent = names[data.strategy] || data.strategy;
                document.getElementById('resDuration').textContent = fmtTime(data.duration);
                document.getElementById('resTransition').textContent = fmtTime(data.transition_point);
                
                const outputUrl = data.output_url.startsWith('http') ? data.output_url : (API_BASE + data.output_url);
                await drawMixWave(outputUrl, data.transition_point, data.duration);
                
                document.getElementById('result').classList.add('show');
                
                document.getElementById('player').src = outputUrl;
                document.getElementById('player').play();

            } catch (err) {
                document.getElementById('error').textContent = err.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('genBtn').disabled = false;
            }
        }

        function fmtTime(s) {
            return Math.floor(s / 60) + ':' + String(Math.floor(s % 60)).padStart(2, '0');
        }

        async function drawMixWave(url, transitionPoint, duration) {
            const canvas = document.getElementById('waveMix');
            const rect = canvas.getBoundingClientRect();
            
            const width = rect.width || 400;
            const height = 56;
            
            canvas.width = width * 2;
            canvas.height = height * 2;
            
            const res = await fetch(url);
            const buffer = await res.arrayBuffer();
            const audio = await audioContext.decodeAudioData(buffer);
            const data = audio.getChannelData(0);
            
            const step = Math.ceil(data.length / canvas.width);
            const amp = canvas.height / 2;
            const t = transitionPoint / duration;
            
            const ctx = canvas.getContext('2d');
            
            // ç»˜åˆ¶æ³¢å½¢
            for (let i = 0; i < canvas.width; i++) {
                const pos = i / canvas.width;
                let min = 1, max = -1;
                for (let j = 0; j < step; j++) {
                    const d = data[i * step + j];
                    if (d < min) min = d;
                    if (d > max) max = d;
                }
                
                const r = Math.round(255 * (1 - pos) + 77 * pos);
                const g = Math.round(77 * (1 - pos) + 121 * pos);
                const b = Math.round(77 * (1 - pos) + 255 * pos);
                ctx.fillStyle = `rgb(${r},${g},${b})`;
                
                ctx.fillRect(i, (1 + min) * amp, 1, Math.max(1, (max - min) * amp));
            }
            
            // è¿‡æ¸¡åŒºåŸŸé«˜äº®
            const mixStart = Math.floor((t - 0.04) * canvas.width);
            const mixEnd = Math.floor((t + 0.04) * canvas.width);
            
            const gradient = ctx.createLinearGradient(mixStart, 0, mixEnd, 0);
            gradient.addColorStop(0, 'rgba(255,255,255,0)');
            gradient.addColorStop(0.5, 'rgba(255,255,255,0.12)');
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(mixStart, 0, mixEnd - mixStart, canvas.height);
        }
    </script>
</body>
</html>
